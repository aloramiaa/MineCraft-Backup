name: ğŸš€ Upload Backup to SFTP (Manual)

on:
  workflow_dispatch:
    inputs:
      host:
        description: "ğŸŒ SFTP Host (e.g. sftp.example.com)"
        required: true
      port:
        description: "ğŸ“¦ SFTP Port (default: 22)"
        required: false
        default: "22"
      username:
        description: "ğŸ‘¤ SFTP Username"
        required: true
      password:
        description: "ğŸ” SFTP Password"
        required: true

jobs:
  upload-to-sftp:
    runs-on: ubuntu-latest
    name: ğŸ”„ Upload Files to SFTP Server

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: ğŸš€ Upload ftp-backup/ to SFTP & Capture Log
        env:
          HOST: ${{ github.event.inputs.host }}
          PORT: ${{ github.event.inputs.port }}
          USER: ${{ github.event.inputs.username }}
          PASS: ${{ github.event.inputs.password }}
        run: |
          echo "Connecting to $HOST:$PORT"
          mkdir -p logs
          lftp -u "$USER","$PASS" -p "$PORT" sftp://"$HOST" -e \
          "set sftp:connect-program \"ssh -a -x -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\"; mirror --reverse --verbose ftp-backup /; bye" | tee logs/upload.log

      - name: ğŸ“„ Show Uploaded Files Summary
        run: |
          echo "ğŸ“„ Uploaded Files:"
          grep "^Transferring file" logs/upload.log | sed 's/.*Transferring file //' || echo "âš ï¸ No files were transferred."
